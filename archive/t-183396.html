<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Analyzing and Manipulating Music Values" />

  <title>Analyzing and Manipulating Music Values - AVS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.1/readable/bootstrap.min.css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <!-- Put navigation bar here -->

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-85.html">AVS</a></li>

      <li class="active">Analyzing and Manipulating Music Values</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=183396">Analyzing and Manipulating Music Values</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

      <p class="post-time small text-muted">15th June 2004 10:09 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content"><strong>Analyzing and Manipulating Music Values</strong><br />
      The most essential thing in AVS is to get the values of the music and setup the presets response to the music. Superscope, DynamicMovement, Texer, etc. offer almost unlimited space for coding mostly used for amazing effects but what about the music beyond simple beat and getosc/getspec?<br />
      <br />
      I searched this forum for some sophisticated methods to analyze the music input but it is difficult to find and most of the time hidden in general coding discussions.<br />
      <br />
      So I think we need a special thread on this particular theme collecting techniques for setting up music response.<br />
      <br />
      Want to start with a try to react to the loudness of the music using a floating average of the music values over a certain amount of frames. Goal was to setup a var "speed" for example to be used for a rotation increasing and decreasing with the music loudness.<br />
      <br />
      fdelta = number of frames used for floating average<br />
      bufstart = number of the first megabuf to store the values<br />
      speedf = factor to adjust the average found to your needs<br />
      <br />
      <font size="1"><br />
      INIT:<br />
      speed=0;fdelta=50;bufstart=50;speedf=1.0;<br />
      <br />
      FRAME:<br />
      pt=bufstart-1;<br />
      loop(fdelta,exec2(assign(pt,pt+1),assign(megabuf(pt),megabuf(pt+1))));<br />
      assign(megabuf(bufstart+fdelta),getspec(0.05,0.9,0));<br />
      pt=bufstart;<br />
      vsum=0;<br />
      loop(fdelta,exec2(assign(pt,pt+1),assign(vsum,vsum+megabuf(pt))));<br />
      vsum=vsum/fdelta;<br />
      speed=vsum*speedf;<br /></font></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Rovastar</span><br /></p>

      <p class="post-time small text-muted">15th June 2004 11:06 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Interesting stuff using a buffer array to store the 'average'.<br />
      <br />
      If feeling brave enter the world of beat detection and other methods in this thread.<br />
      <br />
      <a href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?&amp;threadid=102205" target="_blank">http://forums.winamp.com/showthread....hreadid=102205</a><br />
      <br />
      A bit MIlkDropy at times but we have a few other devolpers in there too from other plugins.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">Tuggummi</span><br /></p>

      <p class="post-time small text-muted">15th June 2004 11:20 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Well i mostly used this very simple method in Extra Dimension, which has it's flaws, but seems to work ok most of the time.<br />
      <br /></p>
      <pre>
<code><br /><u>per frame</u><br />now=gettime(0) ; sec=now-last ; fps=1/sec ; last=now ;<br />vol=vol*0.95+getspec(0.5,1,0) ;<br />speed=(min(3,vol)/fps)*0.1 ;<br />ts=ts*(1-sec) ; t=t+ts<br /><br /><u>per beat</u><br />ts=(rand(51)-25)*speed<br /></code>
</pre><br />
      <br />
      Well first there is the whole speed fixed on fps line,<br />
      then it tries to figure out the current volume. The use of min function there is to prevent some sudden sound peaks that might make the dm/ssc/texer II/etc. spin extremely fast, i have tried to figure out the most common values &amp; top values of the volume with the help of the debugging window and noticed that with this method the value of "vol" hardly goes beyond 3.<br />
      <br />
      Well anyways, i know this is probably not what you mented or wanted, but this is currently working for me quite nicely.<br />
      <br />
      I would gladly hear also what other people use for sound reaction in their presets :up:
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

      <p class="post-time small text-muted">15th June 2004 11:55 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Tried your stuff tuggummi and it's working allright but the response is a little bit jumpy. The advantage of using a floating average (do not know if this is the correct english term for German "gleitender Durchschnitt") is that we get a flowing increase and decrease of the speed and we do not have to mind about short jumps in the volume. Also it is more "exact" since "vsum" will never become bigger than 1.<br />
      <br />
      But I like the idea to have an eye on the fps. I think this could/should be implemented in my approach.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

      <p class="post-time small text-muted">15th June 2004 15:49 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Ok, here is the code for the floating average based on time/fps.<br />
      <br />
      timebase = time in seconds for building the average<br />
      bufstart = first megabuffer to store the values<br />
      vsum = the average<br />
      <br />
      The attached example shows 3 Graphs:<br />
      1. red = original values<br />
      2. yellow = values on a timebase of 0.2 seconds<br />
      3. green = values on a timebase of 2.0 seconds<br />
      <br />
      What is interesting here is that Graph 2 and 3 nicely show the beats. Perhaps this could be used to build a custom beat detection.<br />
      <br />
      <font size="1"><br />
      CODE___________________________________________<br />
      <br />
      INIT:<br />
      timebase=2.0;bufstart=50;<br />
      <br />
      FRAME:<br />
      now=gettime(0);getit=above(now,timeout);<br />
      fps=if(getit,fct,fps);reg10=fps;<br />
      fct=if(getit,0,fct+1);timeout=if(getit,now+1.0,timeout);<br />
      fdelta=timebase*(fps+1);<br />
      pt=bufstart-1;<br />
      loop(fdelta,exec2(assign(pt,pt+1),assign(megabuf(pt),megabuf(pt+1))));<br />
      assign(megabuf(bufstart+fdelta),getspec(0.05,0.9,0));<br />
      pt=bufstart;<br />
      vsum=0;<br />
      loop(fdelta,exec2(assign(pt,pt+1),assign(vsum,vsum+megabuf(pt))));<br />
      vsum=vsum/fdelta;<br />
      speed=vsum*speedf;<br /></font></p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UnConeD</span><br /></p>

      <p class="post-time small text-muted">15th June 2004 19:26 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Actually you can keep an average value much more efficiently ;). Every frame, just add the new value to an accumulator, and subtract the oldest value from the accumulator.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

      <p class="post-time small text-muted">16th June 2004 09:03 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content"></p>

      <blockquote>
        <i>Originally posted by UnConeD</i><br />
        <b>Actually you can keep an average value much more efficiently ;). Every frame, just add the new value to an accumulator, and subtract the oldest value from the accumulator.</b>
        <hr />
      </blockquote>
    </div>
    <hr />
    I thought this is exactly what I am doing here.Is there a better way to manage the values?<br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">[Ishan]</span><br /></p>

      <p class="post-time small text-muted">16th June 2004 10:55 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">i use the same method here, altho i dont think there is a <b>better</b> way....maybe....</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UnConeD</span><br /></p>

      <p class="post-time small text-muted">17th June 2004 13:12 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">"I thought this is exactly what I am doing here.Is there a better way to manage the values?"<br />
      <br />
      As far as I can see, you're adding them together every frame, and even shifting them around all the time, rather than just overwriting the oldest value with the newest.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

      <p class="post-time small text-muted">18th June 2004 06:55 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Quote:</p>
      <hr />
      Ok, I agree the sum could be done without a loop like this:<br />
      <br />
      <br />
      vsum1=vsum1-megabuf(bufstart)+ megabuf(bufstart+fdelta);<br />
      vsum=vsum1/fdelta;<br />
      <br />
      but when testing this I dicovered some little jumps in the average. I think because of the changing fdelta since this is related to timebase &gt; fps which changes a little over time. So I have to average the fps too.<br />
      <br />
      Still can't figure out how to dynamically keep and retrieve the oldest value without this loop :)

      <table cellpadding="6" cellspacing="0" border="0" width="100%">
        <tr>
          <td class="alt2">
            <hr />
            <i>Originally posted by UnConeD</i><br />
            <b>As far as I can see, you're adding them together every frame, and even shifting them around all the time, rather than just overwriting the oldest value with the newest.</b>
            <hr />
          </td>
        </tr>
      </table><br />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">Synth-C</span><br /></p>

        <p class="post-time small text-muted">21st June 2004 16:03 <abbr title="Coordinated Universal Time">UTC</abbr></p>

        <p class="post-content">how about this method:<br />
        <br />
        <font size="1">val=100;<br />
        <br />
        fc1=(fc1+1)%val;fc2=val-fc1;<br />
        assign( megabuf(fc1), getspec(.1,.1,0));<br />
        tot=tot+megabuf(fc1)-megabuf(fc2);<br />
        avg=tot/val;</font><br />
        <br />
        example preset:</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

        <p class="post-time small text-muted">21st June 2004 23:11 <abbr title="Coordinated Universal Time">UTC</abbr></p>

        <p class="post-content">Yeah thats very nice, synth, but there is a small bug. I do not think the results are 100% correct since you do not always subtract the oldest value. fc1 and fc2 are "getting close" ah... do not how to say this in english... like this example:<br />
        <br />
        fc1: 48, 49, 50, 51, 52 ...<br />
        fc2: 52, 51, 50, 49, 48 ...<br />
        <br />
        but I think this will fix the thing<br />
        <br />
        fc1=(fc1+1)%val;fc2=(fc1+1)%val;</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

        <p class="post-time small text-muted">22nd June 2004 08:53 <abbr title="Coordinated Universal Time">UTC</abbr></p>

        <p class="post-content"><strong>My first own beat detection</strong><br />
        Thanx to synth-c for this great setup to build the average. Without this little bug it is working great.<br />
        <br />
        Just added my fps detection to make the average run over time.<br />
        <br />
        Rovastars hint on this beat discussion made me start a desperate try to build up a my own beat detection. Attached you'll find the result. Not too bad for a first try but of course still some things unsolved. The setup does no beat prediction at all since this is very dangerous ground. If prediction fails - a fact in all songs with changing bpm or difficult beats not detected by the setup - you'll get beats at unwanted points. So I think better rely on the pure input.<br />
        <br />
        Difficult beats for this setup are for example a soft base drum behind a loud guitar solo. Don't know how to filter these out. Good prediction would help here but again: if it fails I think it is better to get no beat at all...<br />
        <br />
        The graphs in the attached example show:<br />
        <br />
        green =&gt; the average over time<br />
        yellow =&gt; the original input value<br />
        red =&gt; mybeat<br />
        white =&gt; beat found by AVS<br />
        <br />
        <br />
        <b>The things behind this beat detection:</b><br />
        <br />
        0. Getting the input value<br />
        1. Building a running average of the input value over a given amount of time<br />
        2. Comparing the input value with the average and stating a beat if certain conditions are true<br />
        <br />
        <br />
        <b>Conditions/Assumptions:</b><br />
        <br />
        - The input has to be a certain amount over the average to indicate a beat<br />
        <br />
        - The next beat is only possible if the input has returned to/below the average<br />
        <br />
        - The amount of the input to be over the average is intially set but must be dynamic too to suppress too fast beats and allow beats if no beats are found over a certain time<br />
        <br />
        <b>Dynamic adjustment of the amount of the input to be over the average</b><br />
        <br />
        - To prevent too fast beats after a beat the next beat is suppressed by a linear decreasing additional dumping value over a short amount of time<br />
        <br />
        <br />
        - To get beats if no beats are found after a certain time the intial dumping of the input is lowered on the increasing time after the last beat until a beat is found.</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

        <p class="post-time small text-muted">24th June 2004 10:17 <abbr title="Coordinated Universal Time">UTC</abbr></p>

        <p class="post-content">Here is a new version of my beat detection:<br />
        <br />
        - Used different input "mval" to better detect bass beats<br />
        <br />
        - v_dump adjusts dynamically on volume</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">TomyLobo</span><br /></p>

        <p class="post-time small text-muted">24th June 2004 13:10 <abbr title="Coordinated Universal Time">UTC</abbr></p>

        <p class="post-content">hmm this has some problems with the trance music i'm listening to...<br />
        doesnt detect some of the beats<br />
        <br />
        and in one song it doesnt detect beats at all (Usual Aspect - Mr Blue(Progressive Mix) that is)<br />
        maybe you should only watch the lower bands for beats...</p>
      </div>
      <hr />

      <div class="post">
        <p class="post-meta"><span class="post-author text-primary">EL-VIS2</span><br /></p>

        <p class="post-time small text-muted">25th June 2004 11:20 <abbr title="Coordinated Universal Time">UTC</abbr></p>

        <p class="post-content">Quote:</p>
        <hr />

        <div class="post">
          <p class="post-meta"><span class="post-author text-primary">TomyLobo</span><br /></p>

          <p class="post-time small text-muted">25th June 2004 17:40 <abbr title="Coordinated Universal Time">UTC</abbr></p>

          <p class="post-content">one could skip fast beats, like colormap does<br />
          that is beats that are less than 0.1 sec from each other or something</p>
        </div>
        <hr />

        <div class="footer">
          <p class="text-muted small">Fork me on <a href="https://github.com/visbot/AVS-Forums/">GitHub</a></p>
        </div>

        <table cellpadding="6" cellspacing="0" border="0" width="100%">
          <tr>
            <td class="alt2">
              <hr />
              <i>Originally posted by TomyLobo</i><br />
              <b>maybe you should only watch the lower bands for beats...</b> Yeah I know it is not perfect yet. Works well with a lot of songs but these lower beats are difficult. In mybeat03 I tried to concentrate on the lower bands but still not 100% OK. Perhaps check out lowering v_damp to almost zero.<br />
              <br />
              A lot depends on the bands used for input. So I will do more experimenting with "mval".<br />
              <br />
              What I wanted to get is a less hyperactive beat detection than the one AVS offers since in visualizations too fast beats sometimes ruin the effects. And skipping beats using custombeat setup will fail to get some of the essential beats in a song.
            </td><!-- Put JavaScript here -->
          </tr>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
