<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Refraction (or something that looks like refraction :)" />

  <title>Refraction (or something that looks like refraction :) - AVS Forums</title><!-- Bootstrap core CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootswatch/3.0.2/readable/bootstrap.min.css" /><!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
</head>

<body>
  <div class="container">
    <div class="row">
        <div class="dropdown pull-right">
          <button class="btn btn-link btn-sm dropdown-toggle" type="button" data-toggle="dropdown">
            Change style
            <span class="caret"></span>
          </button>
          <ul id="css-select" class="dropdown-menu" role="menu">
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/readable/bootstrap.min.css">Default</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation" class="dropdown-header">Bootswatch</li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/amelia/bootstrap.min.css">Amelia</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/cerulean/bootstrap.min.css">Cerulean</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/cosmo/bootstrap.min.css">Cosmo</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/cyborg/bootstrap.min.css">Cyborg</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/flatly/bootstrap.min.css">Flatly</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/journal/bootstrap.min.css">Journal</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/readable/bootstrap.min.css">Readable</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/simplex/bootstrap.min.css">Simplex</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/slate/bootstrap.min.css">Slate</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/spacelab/bootstrap.min.css">Spacelab</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/united/bootstrap.min.css">United</a></li>
            <li><a href="#" rel="//netdna.bootstrapcdn.com/bootswatch/3.0.2/yeti/bootstrap.min.css">Yeti</a></li>
          </ul>
        </div>
    </div>

    <ol class="breadcrumb">
      <li><a href="../index.html" class="glyphicon glyphicon-home"></a></li>

      <li><a href="f-137.html">AVS Presets</a></li>

      <li class="active">Refraction (or something that looks like refraction :)</li>
    </ol>

    <p class="lead text-muted">Archive: <a title="Try the Internet Archive" target="_blank" href="http://web.archive.org/web/*/forums.winamp.com/showthread.php?t=171425">Refraction (or something that looks like refraction :)</a></p><br />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TomyLobo</span><br /></p>

      <p class="post-time small text-muted">28th February 2004 22:07 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content"><strong>Refraction (or something that looks like refraction :)</strong><br />
      Hi there :) I experimented a bit with refraction and managed to write an AVS preset that displays a sphere refracting the image on a plane behind it.<br />
      I don't know whether my refraction maths are correct.<br />
      (or better: I *guessed* them *g*)<br />
      Maybe one of you math geeks can check that and/or give me a better formula :)<br />
      <br />
      Here's the code of the DM:<br /></p>
      <pre>
<code><br />//I didn't find a suitable translation for the<br />//German word "Auftreffpunkt" which means the<br />//point where something hits something.<br />//I translated it with "hit point".<br />//1st hit point is the point where the ray hits<br />//the outer bounds of the sphere.<br />//2nd hit point is the point where the ray hits<br />//the inner bounds of the sphere after being refracted.<br /><br />//--- Calculate projection plane coordinates. ---<br />dx=x/zoom; dy=y/zoom; dz=1;<br /><br />//--- Transform them. ---<br />dx1=dx*cz-dy*sz; dy1=dx*sz+dy*cz; dy=dy1*cx-sx; dz1=dy1*sx+dz*cx; dx=dx1*cy-dz1*sy; dz=dx1*sy+dz1*cy;<br /><br />//--- Trace from camera to sphere surface ---<br />// r² = x² + y² + z²<br />// r² = (dx*k+ox-mx)² + (dy*k+oy-my)² + (dz*k+oz-mz)²<br />kdist=(sqr(dx) + sqr(dy) + sqr(dz));<br />kp = (2*dx*(ox-mx) + 2*dy*(oy-my) + 2*dz*(oz-mz))/kdist;<br />kq = (sqr(ox-mx)+sqr(oy-my)+sqr(oz-mz)-sqr(rad))/kdist;<br />kdet=sqr(kp/2)-kq;<br />k1=-kp/2+sqrt(kdet);<br />k2=-kp/2-sqrt(kdet);<br />k1=if(below(k1,0),INFIN,k1);<br />k2=if(below(k2,0),INFIN,k2);<br />ksphere=min(k1,k2);<br /><br />//--- Trace from camera to plane ---<br />pa=0; pb=0; pc=1; pd=-20;<br />k1=(-pa*ox-pb*oy-pc*oz-pd)/(pa*dx + pb*dy + pc*dz);<br />kplane=if(below(k1,0),INFIN,k1);<br /><br />//vec a1: o -&gt; 1st hit point  //vec ik1: &lt;0&gt; -&gt; 1st hit point<br />a1x=dx*ksphere; ik1x=a1x+ox;<br />a1y=dy*ksphere; ik1y=a1y+oy;<br />a1z=dz*ksphere; ik1z=a1z+oz;<br /><br />//--- Does the ray hit the sphere? ---<br />xdist=ik1x-mx; ydist=ik1y-my; zdist=ik1z-mz;<br />distkugel=sqrt(sqr(xdist)+sqr(ydist)+sqr(zdist));<br />isplane=above(abs(9-distkugel),epsilon);<br />k=if(isplane,kplane,ksphere);<br /><br />ix1=dx*kplane+ox; iy1=dy*kplane+oy; iz1=dz*kplane+oz;<br /><br />//The refraction method i used is a linear interpolation<br />//between the normal vector and the traced ray<br />//I'm not sure whether this method is correct. If you know a<br />//better method, let me know :)<br /><br />//--- 1st Refraction ---<br />//Coefficients for recfraction<br />pr=1/refindex; ps=1-pr;<br />//normalise vec a1<br />a1r=invsqrt(sqr(a1x)+sqr(a1y)+sqr(a1z));<br />a1x=a1x*a1r; a1y=a1y*a1r; a1z=a1z*a1r;<br />//vec n: sphere surface normal at the 1st hit point<br />nx=ik1x-mx;<br />ny=ik1y-my;<br />nz=ik1z-mz;<br />//normalise vec n<br />nr=invsqrt(sqr(nx)+sqr(ny)+sqr(nz));<br />nx=nx*nr; ny=ny*nr; nz=nz*nr;<br />//vec b1: Ray after 1st refraction<br />b1x=pr*a1x-ps*nx;<br />b1y=pr*a1y-ps*ny;<br />b1z=pr*a1z-ps*nz;<br />//normalise vec b1<br />b1r=invsqrt(sqr(b1x) + sqr(b1y) + sqr(b1z));<br />b1x=b1x*b1r; b1y=b1y*b1r; b1z=b1z*b1r;<br /><br />//--- Trace inside the sphere---<br />ka=sqr(b1x) + sqr(b1y) + sqr(b1z);<br />kp=(2*b1x*(ik1x-mx) + 2*b1y*(ik1y-my) + 2*b1z*(ik1z-mz))/ka;<br />kq=(sqr(ik1x-mx)+sqr(ik1y-my)+sqr(ik1z-mz)-sqr(rad))/ka;<br />kdet=sqr(kp/2)-kq;<br />k1=-kp/2+sqrt(kdet);<br />//k2=-kp/2-sqrt(kdet);<br />k1=if(below(k1,0),INFIN,k1);<br />//k2=if(below(k2,0),INFIN,k2);<br />ksphere2=k1;<br /><br />//--- 2nd refraction ---<br />//Coefficients for recfraction<br />pr=1/refindex; ps=1-pr;<br />//vec a2: 1st hit point -&gt; 2nd hit point // vec ik2: &lt;0&gt; -&gt; 2nd hit point<br />a2x=b1x*ksphere2; ik2x=a2x+ik1x;<br />a2y=b1y*ksphere2; ik2y=a2y+ik1y;<br />a2z=b1z*ksphere2; ik2z=a2z+ik1z;<br />//normalise vec a2 (keep a2r for light dimming calculations)<br />a2r=sqrt(sqr(a2x)+sqr(a2y)+sqr(a2z));<br />a2x=a2x/a2r; a2y=a2y/a2r; a2z=a2z/a2r;<br />//vec n: sphere surface normal at the 2nd hit point<br />nx=ik2x-mx;<br />ny=ik2y-my;<br />nz=ik2z-mz;<br />//normalise vec n<br />nr=invsqrt(sqr(nx)+sqr(ny)+sqr(nz));<br />nx=nx*nr; ny=ny*nr; nz=nz*nr;<br />//vec b2: Ray after 2nd refraction<br />b2x=pr*a2x+ps*nx;<br />b2y=pr*a2y+ps*ny;<br />b2z=pr*a2z+ps*nz;<br /><br />//--- Trace refracted ray to the plane  ---<br />k1=(-pa*ik2x-pb*ik2y-pc*ik2z-pd)/(pa*b2x + pb*b2y + pc*b2z);<br />kplane2=if(below(k1,0),INFIN,k1);<br />ix2=b2x*kplane2+ik2x; iy2=b2y*kplane2+ik2y; iz2=b2z*kplane2+ik2z;<br /><br />//--- Get coordinates of the point where the ray ends<br />ix=if(isplane,ix1,ix2);<br />iy=if(isplane,iy1,iy2);<br />iz=if(isplane,iz1,iz2);<br /><br />//--- Determine texture coordinates ---<br />x=ix/40; y=iy/40;<br /><br />//--- Determine Alpha ---<br />// Calculate distance to camera.<br />xdist=ix-ox; ydist=iy-oy; zdist=iz-oz;<br />dist=sqrt(sqr(xdist)+sqr(ydist)+sqr(zdist));<br />//if (plane) then (100% Alpha) else (calculate from distance between the 2 hitpoints)<br />alpha=if(isplane,1,exp(-a2r/50));<br />//if (dist&gt;=viewdist) then (0% Alpha)<br />alpha=alpha*below(dist,viewdist);<br />alpha=if(equal(k,INFIN),0,alpha);<br /></code>
</pre>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UIUC85</span><br /></p>

      <p class="post-time small text-muted">29th February 2004 01:33 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">lol at first I didn't realize you could look around with the mouse and I wasn't impressed at all but after I figured that I have to say that makes it a lot better. The refraction doesn't look quite right to me but then again maybe I'm wrong. Nice work though!</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TomyLobo</span><br /></p>

      <p class="post-time small text-muted">29th February 2004 01:58 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">i'm 100% sure that it's correct for a refraction index of 1 *g*<br />
      but as is said the formula is guessed it looks like refraction to me and it bends the rays when they hit the surface in the correct direction but since it produces some garbage for refraction indixes &lt; 1, I don't think my formula is correct... but it looks nice though doesn't it? :)<br />
      I hope someone with better maths skills than me can solve that problem :)</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UnConeD</span><br /></p>

      <p class="post-time small text-muted">29th February 2004 12:44 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Refraction goes like this: if ***952;1 is the angle between the incoming ray and the surface normal, and ***952;2 is the angle between the outgoing/refracted ray and the surface normal, then:<br />
      <br /></p>
      <pre>
<code><br /><u>sin ***952;2</u> = <u>n1</u><br />sin ***952;1   n2<br /></code>
</pre><br />
      <br />
      Where n1 and n2 are the refraction indices of the first and second material.
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">TomyLobo</span><br /></p>

      <p class="post-time small text-muted">29th February 2004 13:08 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">I found that formula, too, but how do i rotate a vector around an axis that is not the x, y or z axis?<br />
      <br />
      [edit]<br />
      That axis should be the normal vector of the plane containing the incoming ray and the sphere surface normal vector right? :)<br />
      [/edit]</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">hungryskull</span><br /></p>

      <p class="post-time small text-muted">29th February 2004 16:11 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content">Well, I guess it works pretty close to correct. I don't really know what you wanted.</p>
    </div>
    <hr />

    <div class="post">
      <p class="post-meta"><span class="post-author text-primary">UIUC85</span><br /></p>

      <p class="post-time small text-muted">29th February 2004 19:03 <abbr title="Coordinated Universal Time">UTC</abbr></p>

      <p class="post-content"><a href="http://www.siggraph.org/education/materials/HyperGraph/modeling/mod_tran/3drota.htm" target="_blank">http://www.siggraph.org/education/ma...ran/3drota.htm</a><br />
      <br />
      Check you rotation around an arbitrary axis. That should help.</p>
    </div>
    <hr />

    <div class="footer">
      <p class="text-muted small">Fork me on <a href="https://github.com/visbot/AVS-Forums/">GitHub</a></p>
    </div>
  </div><!-- Put JavaScript here -->
  <script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="../js/jquery.cookie.min.js"></script>
  <script type="text/javascript" src="../js/scripts.js"></script>
</body>
</html>
